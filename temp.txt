// src/App.tsx

import React, { useState, useRef, useCallback, useEffect, useMemo } from 'react';
import {
  Mic, MicOff, Play, Square, Users, Sparkles, RefreshCw,
  AlertCircle, X, Share2, Download, Heart, Star, Zap, Music, ArrowRight, ArrowLeft, Info, CheckCircle2
} from 'lucide-react';
import html2canvas from 'html2canvas';
import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer } from 'recharts';
import './App.css';

// --- ìƒìˆ˜ ë°ì´í„° ---
const sampleTexts: string[] = [
  "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì»¤í”¼ë¥¼ ì •ë§ ì¢‹ì•„í•˜ê³ , ì£¼ë§ì—ëŠ” ë“œë¼ë§ˆ ì •ì£¼í–‰ì„ ì¦ê²¨ìš”.",
  "ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì •ë§ ì¢‹ë„¤ìš”. ì´ëŸ° ë‚ ì—” ì‚°ì±…í•˜ë©´ì„œ ìŒì•… ë“£ëŠ” ê²Œ ìµœê³ ì¸ ê²ƒ ê°™ì•„ìš”.",
  "ì œê°€ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìŒì‹ì€ ì¹˜í‚¨ì¸ë°ìš”, ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ë¨¹ìœ¼ë©´ ë” ë§›ìˆì–´ìš”.",
  "ì±… ì½ê¸°ì™€ ì˜í™” ë³´ê¸°ë¥¼ ì¢‹ì•„í•´ìš”. íŠ¹íˆ ê°ë™ì ì¸ ìŠ¤í† ë¦¬ì— ì•½í•œ í¸ì´ì—ìš”.",
  "ì—¬í–‰ì„ ì •ë§ ì¢‹ì•„í•´ì„œ ìƒˆë¡œìš´ ê³³ì„ íƒí—˜í•˜ëŠ” ê²Œ ì œ ì·¨ë¯¸ ì¤‘ í•˜ë‚˜ì˜ˆìš”.",
];

// --- íƒ€ì… ì •ì˜ ---
type Status = 'idle' | 'recording' | 'recorded' | 'analyzing' | 'result';
interface AnalysisResult {
  age_range: string;
  humor_quote: string;
  voice_type: string;
  attraction_score: number;
  animal_type: { type: string; emoji: string; desc: string };
  personality_type: { type: string; emoji: string; color: string };
  compatibility_job: string;
  special_tag: string;
  voice_color: string;
  uniqueness_score: number;
  radar_data: { feature: string; value: number }[];
}
interface RecordedAudio { blob: Blob; url: string; }

// --- í—¬í¼ í•¨ìˆ˜ ---
const getRandomSample = () => sampleTexts[Math.floor(Math.random() * sampleTexts.length)];

// ì›í˜• ì§„í–‰ í‘œì‹œ(10ì´ˆ)
const RecordProgress: React.FC<{ sec: number; max?: number }> = ({ sec, max = 10 }) => {
  const pct = Math.min(100, (sec / max) * 100);
  const radius = 54, stroke = 8, C = 2 * Math.PI * radius;
  const dash = (pct / 100) * C;
  return (
    <svg width="130" height="130" role="progressbar" aria-valuenow={Math.floor(pct)} aria-valuemin={0} aria-valuemax={100}>
      <circle cx="65" cy="65" r={radius} stroke="rgba(255,255,255,.25)" strokeWidth={stroke} fill="none" />
      <circle cx="65" cy="65" r={radius} stroke="#22c55e" strokeWidth={stroke} fill="none"
        strokeDasharray={`${dash} ${C - dash}`} strokeLinecap="round" transform="rotate(-90 65 65)" />
      <text x="50%" y="50%" textAnchor="middle" dominantBaseline="central" fontWeight={800} fontSize="20" fill="#fff">
        {sec.toFixed(1)}s
      </text>
    </svg>
  );
};

// ë ˆì´ë” ì°¨íŠ¸
const VoiceRadarChart: React.FC<{ data: { feature: string; value: number }[] }> = ({ data }) => (
  <div className="radar-chart-container">
    <ResponsiveContainer width="100%" height={250}>
      <RadarChart cx="50%" cy="50%" outerRadius="80%" data={data}>
        <PolarGrid stroke="rgba(255, 255, 255, 0.5)" />
        <PolarAngleAxis dataKey="feature" tick={{ fill: 'white', fontSize: 13, fontWeight: 600 }} />
        <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
        <Radar name="Voice" dataKey="value" stroke="#fbbf24" fill="#fbbf24" fillOpacity={0.6} />
      </RadarChart>
    </ResponsiveContainer>
  </div>
);

const ResultCaptureCard: React.FC<{ result: AnalysisResult }> = ({ result }) => (
  <div id="resultCardToCapture" className="share-card">
    <div className="share-card__frame" />
    <div className="share-card__ribbon">
      <div className="ribbon__logo"><Sparkles size={18} /></div>
      <span className="ribbon__brand">VOICEAGE</span>
      <span className="ribbon__tagline">AI Voice Personality</span>
    </div>
    <div className="share-card__content">
      <div className="share-card__title">
        <h2>ëª©ì†Œë¦¬ ë¶„ì„ ê²°ê³¼</h2>
        <span className="badge">{result.voice_color}</span>
      </div>
      <div className="share-card__headline">
        <div className="headline__age">
          <span className="age__label">ëª©ì†Œë¦¬ ë‚˜ì´</span>
          <span className="age__value">{result.age_range}</span>
        </div>
        <div className="headline__metrics">
          <div className="metric">
            <Heart size={16} /><span className="metric__label">ë§¤ë ¥ë„</span><span className="metric__value">{result.attraction_score}</span>
          </div>
          <div className="metric">
            <Star size={16} /><span className="metric__label">ìœ ë‹ˆí¬</span><span className="metric__value">{result.uniqueness_score}%</span>
          </div>
        </div>
      </div>
      <blockquote className="share-card__quote">â€œ{result.humor_quote}â€</blockquote>
      <div className="share-card__grid">
        <div className="mini-card">
          <div className="mini-card__head"><span className="emoji">{result.animal_type.emoji}</span><span className="mini-card__title">ë™ë¬¼ìƒ</span></div>
          <div className="mini-card__value">{result.animal_type.type}</div>
          <div className="mini-card__desc">{result.animal_type.desc}</div>
        </div>
        <div className="mini-card">
          <div className="mini-card__head"><span className="emoji" style={{ color: result.personality_type.color }}>{result.personality_type.emoji}</span><span className="mini-card__title">ì„±ê²©</span></div>
          <div className="mini-card__value">{result.personality_type.type}</div>
        </div>
        <div className="mini-card">
          <div className="mini-card__head"><Zap size={16} /><span className="mini-card__title">ë³´ì´ìŠ¤</span></div>
          <div className="mini-card__value">{result.voice_type}</div>
        </div>
        <div className="mini-card">
          <div className="mini-card__head"><span className="emoji">ğŸ’¼</span><span className="mini-card__title">ì–´ìš¸ë¦¬ëŠ” ì§ì—…</span></div>
          <div className="mini-card__value">{result.compatibility_job}</div>
        </div>
      </div>
      <div className="share-card__hashtags">
        <span className="tag">#{result.special_tag.replace(/\s/g, '')}</span>
        <span className="tag">#{result.voice_color.replace(/\s/g, '')}</span>
        <span className="tag">#VoiceAge</span>
      </div>
    </div>
    <div className="share-card__footer">
      <div className="footer__brand"><Sparkles size={14} /><span>VOICEAGE</span></div>
      <span className="footer__url">voiceage.app</span>
    </div>
  </div>
);

// ì¸ì‚¬ì´íŠ¸ ì¹© ê³„ì‚°
const computeInsightChips = (radar: AnalysisResult['radar_data']) => {
  const labelPos: Record<string, string> = {'ë†’ì´': 'ê³ ìŒë„ ë†’ìŒ', 'ì—ë„ˆì§€': 'ì—ë„ˆì§€ ë„˜ì¹¨', 'ì†ë„': 'ë§ ì†ë„ ë¹ ë¦„', 'ë§‘ìŒ': 'ë§‘ì€ í†¤', 'ì•ˆì •ê°': 'ì•ˆì •ê° ë†’ìŒ'};
  const labelNeg: Record<string, string> = {'ë†’ì´': 'ì €ìŒ ê¸°ì¡°', 'ì—ë„ˆì§€': 'ì°¨ë¶„í•¨', 'ì†ë„': 'ë§ ì†ë„ ëŠë¦¼', 'ë§‘ìŒ': 'í—ˆìŠ¤í‚¤ í†¤', 'ì•ˆì •ê°': 'í†¤ ë³€ë™ í¼'};
  const top = [...radar].sort((a, b) => b.value - a.value).slice(0, 3);
  return top.map(({ feature, value }) => value >= 60 ? (labelPos[feature] || feature) : value <= 40 ? (labelNeg[feature] || feature) : feature);
};

// ê³µìœ  ë¬¸êµ¬
const shareText = (r: AnalysisResult) => `ğŸ¤ ë‚´ ë³´ì´ìŠ¤ ì—ì´ì§€: ${r.age_range}\nâ€œ${r.humor_quote}â€\n#${r.special_tag.replace(/\s/g,'')} #${r.voice_color.replace(/\s/g,'')} #VoiceAge`;

const VoiceAgeApp: React.FC = () => {
  const [status, setStatus] = useState<Status>('idle');
  const [gender, setGender] = useState<'male' | 'female' | null>(null);
  const [recordedAudio, setRecordedAudio] = useState<RecordedAudio | null>(null);
  const [recordingTime, setRecordingTime] = useState<number>(0);
  const [totalUsers, setTotalUsers] = useState<number>(15247);
  const [currentSample, setCurrentSample] = useState<string>(getRandomSample());
  const [error, setError] = useState<string | null>(null);
  const [analysisResult, setAnalysisResult] = useState<AnalysisResult | null>(null);
  const [isCapturing, setIsCapturing] = useState(false);
  const [resultView, setResultView] = useState<'summary' | 'details'>('summary');
  const [toast, setToast] = useState<string | null>(null);
  const [showPrivacy, setShowPrivacy] = useState(false);

  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const recordingTimeRef = useRef(recordingTime);
  const stopMeterRef = useRef<(() => void) | null>(null);
  const titleRef = useRef<HTMLHeadingElement | null>(null);

  useEffect(() => {
    const interval = setInterval(() => setTotalUsers(prev => prev + Math.floor(Math.random() * 5) + 1), 3000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    let timer: number | undefined;
    if (status === 'recording') {
      timer = window.setInterval(() => {
        setRecordingTime(prev => {
          if (prev >= 9.9) {
            if (mediaRecorderRef.current?.state === 'recording') mediaRecorderRef.current.stop();
            return 10;
          }
          return +(prev + 0.1).toFixed(1);
        });
      }, 100);
    }
    return () => { if (timer) window.clearInterval(timer); };
  }, [status]);

  useEffect(() => { recordingTimeRef.current = recordingTime; }, [recordingTime]);

  const setupLiveMeter = (stream: MediaStream) => {
    const Ctx = (window as any).AudioContext || (window as any).webkitAudioContext;
    if (!Ctx) return () => {};
    const ctx = new Ctx();
    const src = ctx.createMediaStreamSource(stream);
    const analyser = ctx.createAnalyser(); analyser.fftSize = 256;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    const bars = 16;
    let raf = 0;
    const tick = () => {
      analyser.getByteTimeDomainData(data);
      let sum = 0;
      for (let i = 0; i < data.length; i++) {
        const v = (data[i] - 128) / 128; sum += v * v;
      }
      const rms = Math.sqrt(sum / data.length);
      const arr = Array.from({ length: bars }, (_, i) => Math.max(0, Math.min(1, rms * (1 + i * 0.15))));
      const root = document.documentElement;
      root.style.setProperty('--meter-rms', String(rms));
      root.style.setProperty('--meter-bars', String(bars));
      arr.forEach((lv, idx) => root.style.setProperty(`--meter-${idx}`, String(lv)));
      raf = requestAnimationFrame(tick);
    };
    raf = requestAnimationFrame(tick);
    return () => { cancelAnimationFrame(raf); try { ctx.close(); } catch {} };
  };

  const showToast = (t: string) => { setToast(t); window.setTimeout(() => setToast(null), 2200); };

  const startRecording = useCallback(async () => {
    setError(null); if (status !== 'idle' || !gender) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 44100, channelCount: 1, echoCancellation: true, noiseSuppression: true } });
      streamRef.current = stream; const audioChunks: Blob[] = [];
      const mimeType = 'audio/webm;codecs=opus';
      const mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorderRef.current = mediaRecorder;
      stopMeterRef.current = setupLiveMeter(stream);
      mediaRecorder.ondataavailable = (event: BlobEvent) => { if (event.data.size > 0) audioChunks.push(event.data); };
      mediaRecorder.onstop = () => {
        stopMeterRef.current?.(); stopMeterRef.current = null;
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        if (recordingTimeRef.current < 2) {
          setError("ë„ˆë¬´ ì§§ì•„ìš”! 2ì´ˆ ì´ìƒ ë…¹ìŒí•´ì•¼ ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•´ìš”.");
          setCurrentSample(getRandomSample());
          setStatus('idle'); setRecordingTime(0); setRecordedAudio(null);
        } else {
          const audioUrl = URL.createObjectURL(audioBlob);
          setRecordedAudio({ blob: audioBlob, url: audioUrl });
          setStatus('recorded');
        }
        if (streamRef.current) streamRef.current.getTracks().forEach(track => track.stop());
      };
      mediaRecorder.start(); setStatus('recording'); setRecordingTime(0);
    } catch (err) {
      console.error('ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:', err);
      setError('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”!');
    }
  }, [status, gender]);

  const stopRecording = useCallback(() => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') mediaRecorderRef.current.stop();
  }, []);

  const playRecording = useCallback(() => { if (recordedAudio) new Audio(recordedAudio.url).play(); }, [recordedAudio]);

  const getNewSample = () => {
    let newSample;
    do { newSample = getRandomSample(); } while (newSample === currentSample);
    setCurrentSample(newSample);
  };

  const resetAll = useCallback(() => {
    if (recordedAudio) URL.revokeObjectURL(recordedAudio.url);
    setRecordedAudio(null); setRecordingTime(0); setStatus('idle'); setError(null); setAnalysisResult(null); setResultView('summary'); setGender(null);
  }, [recordedAudio]);

  const analyzeVoice = useCallback(async () => {
    if (!recordedAudio || !gender) { setError("ì„±ë³„ì„ ì„ íƒí•´ì•¼ ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    setStatus('analyzing'); setError(null);
    const formData = new FormData();
    formData.append('gender', gender);
    formData.append('audio', recordedAudio.blob, 'recording.webm');
    try {
      const apiUrl = `${import.meta.env.VITE_API_URL}/api/analyze`;
      const response = await fetch(apiUrl, { method: 'POST', body: formData });
      // const response = await fetch('/api/analyze', { method: 'POST', body: formData });
      if (!response.ok) {
        let msg = 'ë¶„ì„ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        try { const errorData = await response.json(); msg = errorData.detail || msg; } catch {}
        throw new Error(msg);
      }
      const result: AnalysisResult = await response.json();
      setAnalysisResult(result); setStatus('result');
      setTimeout(() => titleRef.current?.focus(), 30);
    } catch (err: any) {
      console.error('ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:', err);
      setError(err.message || 'ë¶„ì„ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      showToast('ì—°ê²°ì´ ë¶ˆì•ˆì •í•´ìš”. 3ì´ˆ í›„ ìë™ ì¬ì‹œë„í•©ë‹ˆë‹¤.');
      setStatus('recorded');
      setTimeout(() => analyzeVoice(), 3000);
    }
  }, [recordedAudio, gender]);

  const captureResultCard = useCallback(async (): Promise<Blob | null> => {
    setIsCapturing(true);
    await new Promise(resolve => setTimeout(resolve, 100));
    const cardElement = document.getElementById('resultCardToCapture') || document.querySelector('.result-container');
    if (!cardElement) { console.error('ìº¡ì²˜í•  ê²°ê³¼ ì¹´ë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); setIsCapturing(false); return null; }
    try {
      const scale = Math.min(3, Math.max(2, (window.devicePixelRatio || 1) * 1.25));
      const canvas = await html2canvas(cardElement as HTMLElement, { backgroundColor: '#6B5FAA', useCORS: true, scale });
      return new Promise(resolve => canvas.toBlob(blob => resolve(blob), 'image/png'));
    } catch (error) {
      console.error('ê²°ê³¼ ì¹´ë“œ ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨:', error); return null;
    } finally { setIsCapturing(false); }
  }, []);

  const shareResult = useCallback(async () => {
    if (!analysisResult) return;
    const blob = await captureResultCard(); if (!blob) { alert('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }
    const file = new File([blob], 'voice-age-result.png', { type: 'image/png' });
    const text = shareText(analysisResult);
    const shareData: any = { title: 'ë³´ì´ìŠ¤ì—ì´ì§€ - ë‚´ ëª©ì†Œë¦¬ ë¶„ì„ ê²°ê³¼!', text, url: window.location.href };
    if (navigator.canShare?.({ files: [file] })) shareData.files = [file];
    try {
      if (navigator.share) await navigator.share(shareData);
      else throw new Error('web share not supported');
    } catch {
      try {
        await navigator.clipboard.writeText(`${text}\n${window.location.href}`);
        alert('ê³µìœ  ë¬¸êµ¬ì™€ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”! ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ì–´ ê³µìœ í•´ë³´ì„¸ìš”.');
      } catch (e) {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', e);
        alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. "ì €ì¥í•˜ê¸°"ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.');
      }
    }
  }, [analysisResult, captureResultCard]);

  const downloadResult = useCallback(async () => {
    const blob = await captureResultCard(); if (!blob) { alert('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }
    const url = URL.createObjectURL(blob); const link = document.createElement('a');
    link.href = url; link.download = 'ë³´ì´ìŠ¤ì—ì´ì§€-ê²°ê³¼.png'; document.body.appendChild(link);
    link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
  }, [captureResultCard]);

  const insightChips = useMemo(() => analysisResult ? computeInsightChips(analysisResult.radar_data) : [], [analysisResult]);

  const renderMainContent = () => {
    switch (status) {
      case 'recording': return (<div className="status-content"><RecordProgress sec={recordingTime} /><div className="recording-text"><div className="info">ë…¹ìŒ ì¤‘...</div><div className="recording-wave" aria-hidden="true">{Array.from({ length: 16 }).map((_, i) => (<div key={i} className="wave-bar" style={{ height: `calc(8px + var(--meter-${i}, 0) * 32px)` }} />))}</div></div></div>);
      case 'recorded': return (<div className="status-content"><div className="recorded-icon"><Square size={48} color="white" /></div><div className="recorded-text"><h2>ë…¹ìŒ ì™„ë£Œ!</h2><p aria-live="polite">{recordingTime.toFixed(1)}ì´ˆ ë¶„ëŸ‰</p><div className="recorded-preview"><Music size={16} /><span>ëª©ì†Œë¦¬ ë°ì´í„° ì¤€ë¹„ë¨</span></div></div></div>);
      case 'analyzing': return (<div className="status-content"><div className="analyzing-icon"><div className="analyzing-icon-inner"><Sparkles size={32} color="white" /></div></div><div className="analyzing-text"><h2>AI ë¶„ì„ ì¤‘...</h2><p>ëª©ì†Œë¦¬ DNAë¥¼ í™•ì¸í•˜ê³  ìˆì–´ìš”! (ì•½ 2~3ì´ˆ)</p><div className="analyzing-steps"><div className="step active">ìŒì„± íŒŒí˜• ë¶„ì„</div><div className="step active">í†¤ ë¶„ì„</div><div className="step loading">ì„±ê²© ìœ í˜• ë§¤ì¹­</div></div></div></div>);
      case 'result':
        if (!analysisResult) return null;
        if (resultView === 'summary') {
          const isUnique = analysisResult.uniqueness_score >= 90;
          return (<div className="result-container result-summary"><div className="result-header"><h2 ref={titleRef} tabIndex={-1} className="result-title" aria-live="polite">{analysisResult.age_range}ì˜ ëª©ì†Œë¦¬ {isUnique && <span className="badge-unique">UNIQUE 90+</span>}</h2><p className="humor-quote">"{analysisResult.humor_quote}"</p></div>{insightChips.length > 0 && (<div className="insight-chips" aria-label="ëª©ì†Œë¦¬ ì¸ì‚¬ì´íŠ¸">{insightChips.map((chip, i) => <span key={i} className="chip">{chip}</span>)}</div>)}<h3 className="radar-title">ëª©ì†Œë¦¬ íŠ¹ì§• ë¶„ì„</h3><VoiceRadarChart data={analysisResult.radar_data} /><div className="scores-row"><div className="score-item"><Heart className="score-icon" size={20} /><span className="score-label">ë§¤ë ¥ë„</span><span className="score-value">{analysisResult.attraction_score}ì </span><p className="score-desc">ëª©ì†Œë¦¬ì˜ ì•ˆì •ê°ê³¼ í¸ì•ˆí•¨</p></div><div className="score-item"><Star className="score-icon" size={20} /><span className="score-label">ìœ ë‹ˆí¬</span><span className="score-value">{analysisResult.uniqueness_score}%</span><p className="score-desc">ë‹¤ë¥¸ ëª©ì†Œë¦¬ì™€ì˜ ì°¨ë³„ì„±</p></div></div><button onClick={() => setResultView('details')} className="btn btn-details" aria-label="ìƒì„¸ ê²°ê³¼ ë³´ê¸°">ìì„¸í•œ ê²°ê³¼ ë³´ê¸° <ArrowRight size={18} /></button></div>);
        } else {
          return (<div className="result-container result-details"><div className="result-header"><h2 className="result-title">ìƒì„¸ ë¶„ì„ ê²°ê³¼</h2></div><div className="result-details-grid"><div className="detail-card animal-card"><div className="card-header"><span className="animal-emoji">{analysisResult.animal_type.emoji}</span><div><h4>ëª©ì†Œë¦¬ ë™ë¬¼ìƒ</h4><p>{analysisResult.animal_type.type}</p></div></div><span className="card-desc">{analysisResult.animal_type.desc}</span></div><div className="detail-card personality-card"><div className="card-header"><span className="personality-emoji" style={{ color: analysisResult.personality_type.color }}>{analysisResult.personality_type.emoji}</span><div><h4>ì„±ê²© ìœ í˜•</h4><p>{analysisResult.personality_type.type}</p></div></div></div><div className="detail-card voice-card"><div className="card-header"><Zap size={24} color="#8b5cf6" /><div><h4>ëª©ì†Œë¦¬ íƒ€ì…</h4><p>{analysisResult.voice_type}</p></div></div></div><div className="detail-card job-card"><div className="card-header"><span className="job-emoji">ğŸ’¼</span><div><h4>ì–´ìš¸ë¦¬ëŠ” ì§ì—…</h4><p>{analysisResult.compatibility_job}</p></div></div></div></div><div className="special-tags"><span className="special-tag">#{analysisResult.special_tag}</span><span className="special-tag">#{analysisResult.voice_color}</span></div><button onClick={() => setResultView('summary')} className="btn btn-back" aria-label="ìš”ì•½ìœ¼ë¡œ ëŒì•„ê°€ê¸°"><ArrowLeft size={18} /> ìš”ì•½ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button></div>);
        }
      case 'idle':
      default:
        return (
          <div className="status-content">
            <div className="gender-selector">
              <h3 className="gender-title">ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
              <div className="gender-buttons">
                <button className={`btn-gender ${gender === 'male' ? 'selected' : ''}`} onClick={() => setGender('male')} aria-pressed={gender === 'male'}>ë‚¨ì„± {gender === 'male' && <CheckCircle2 size={20} />}</button>
                <button className={`btn-gender ${gender === 'female' ? 'selected' : ''}`} onClick={() => setGender('female')} aria-pressed={gender === 'female'}>ì—¬ì„± {gender === 'female' && <CheckCircle2 size={20} />}</button>
              </div>
            </div>
            <button className="idle-icon" onClick={startRecording} disabled={!gender} aria-label="ë…¹ìŒ ì‹œì‘"><div className="mic-pulse"><Mic size={64} color="white" /></div></button>
            <div className="idle-text">
              <h2>{gender ? "ëª©ì†Œë¦¬ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”!" : "ì„±ë³„ ì„ íƒ í›„ ì‹œì‘"}</h2>
              <p>10ì´ˆë©´ ì¶©ë¶„í•´ìš”</p>
            </div>
          </div>
        );
    }
  };

  return (
    <div className="app-container">
      <header className="app-header">
        <div className="title-group"><Sparkles size={32} className="sparkle-icon" /><h1>ë³´ì´ìŠ¤ì—ì´ì§€</h1><Sparkles size={32} className="sparkle-icon" /></div>
        <p className="subtitle">AIê°€ ë¶„ì„í•˜ëŠ” ë‚´ ëª©ì†Œë¦¬ì˜ ëª¨ë“  ê²ƒ</p>
        <div className="header-row">
          <div className="user-counter"><Users size={20} /><span>ì§€ê¸ˆê¹Œì§€ {totalUsers.toLocaleString()}ëª…ì´ í…ŒìŠ¤íŠ¸í–ˆì–´ìš”!</span></div>
          <button className="privacy-btn" aria-label="í”„ë¼ì´ë²„ì‹œ ì•ˆë‚´" onClick={() => setShowPrivacy(true)}><Info size={18} /> ì •ë³´</button>
        </div>
      </header>
      <main className="main-content">
        <div className="card">
          <div className="card-status-display">{renderMainContent()}</div>
          {(status === 'idle' || status === 'recording') && (<div className="sample-text-box" aria-live="polite"><div className="sample-text-header"><span>ğŸ’¬ ì´ëŸ° ì‹ìœ¼ë¡œ ë§í•´ë³´ì„¸ìš”:</span><button onClick={getNewSample} title="ë‹¤ë¥¸ ì˜ˆì‹œ ë³´ê¸°" aria-label="ìƒ˜í”Œ ë¬¸ì¥ ë°”ê¾¸ê¸°"><RefreshCw size={16} /></button></div><p>"{currentSample}"</p></div>)}
          {error && (<div className="error-box" role="alert"><AlertCircle size={20} /><span>{error}</span><button onClick={() => setError(null)} aria-label="ì˜¤ë¥˜ ë©”ì‹œì§€ ë‹«ê¸°"><X size={20} /></button></div>)}
          <div className="button-group">
            {status === 'idle' && (<button onClick={startRecording} className="btn btn-primary" disabled={!gender} aria-label="ë…¹ìŒ ì‹œì‘"><Mic size={20} />{gender ? 'ë…¹ìŒ ì‹œì‘' : 'ì„±ë³„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'}</button>)}
            {status === 'recording' && (<button onClick={stopRecording} className="btn btn-danger" aria-label="ë…¹ìŒ ì¤‘ì§€"><MicOff size={20} />ë…¹ìŒ ì¤‘ì§€</button>)}
            {status === 'recorded' && (<><button onClick={playRecording} className="btn btn-secondary" aria-label="ë…¹ìŒ ì¬ìƒ"><Play size={18} />ë…¹ìŒ ì¬ìƒ</button><div className="grid-buttons"><button onClick={resetAll} className="btn btn-light" aria-label="ë‹¤ì‹œ ë…¹ìŒ">ë‹¤ì‹œ ë…¹ìŒ</button><button onClick={analyzeVoice} className="btn btn-accent" aria-label="ë¶„ì„ ì‹œì‘"><Sparkles size={18} />ë¶„ì„ ì‹œì‘!</button></div></>)}
            {status === 'result' && (<button onClick={resetAll} className="btn btn-primary" aria-label="ë‹¤ì‹œ ë¶„ì„í•˜ê¸°"><RefreshCw size={20} /> ë‹¤ì‹œ ë¶„ì„í•˜ê¸°</button>)}
          </div>
        </div>
      </main>
      <footer className="app-footer"><p>ğŸ¯ ëª©ì†Œë¦¬ ë‚˜ì´ëŒ€ + ì„±ê²© + ë§¤ë ¥ë„ + ë™ë¬¼ìƒê¹Œì§€!</p></footer>
      {status === 'result' && analysisResult && (<div className="cta-sticky" role="region" aria-label="ê³µìœ  ë° ì €ì¥"><button onClick={shareResult} className="btn btn-share" aria-label="ê²°ê³¼ ê³µìœ í•˜ê¸°"><Share2 size={18} />ê³µìœ </button><button onClick={downloadResult} className="btn btn-download" aria-label="ê²°ê³¼ ì €ì¥í•˜ê¸°"><Download size={18} />ì €ì¥</button></div>)}
      {isCapturing && analysisResult && (<div className="capture-container"><ResultCaptureCard result={analysisResult} /></div>)}
      {isCapturing && !analysisResult && (<div className="modal-overlay"><div className="share-modal"><h3>ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„± ì¤‘...</h3><p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p><div className="analyzing-icon"><div className="analyzing-icon-inner"><Download size={32} color="white" /></div></div></div></div>)}
      {showPrivacy && (<div className="modal-overlay" onClick={() => setShowPrivacy(false)}><div className="privacy-modal" onClick={(e) => e.stopPropagation()}><div className="privacy-head"><h3>í”„ë¼ì´ë²„ì‹œ ì•ˆë‚´</h3><button aria-label="ë‹«ê¸°" onClick={() => setShowPrivacy(false)}><X size={18} /></button></div><ul className="privacy-list"><li>ğŸ¤ ë…¹ìŒì€ ë¶„ì„ ëª©ì ì—ë§Œ ì‚¬ìš©ë˜ë©° ì„œë²„ì— ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li><li>â± 10ì´ˆ ì´ë‚´ì˜ ì§§ì€ ë°œí™”ê°€ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.</li><li>ğŸ”‡ ì¡°ìš©í•œ í™˜ê²½ì—ì„œ ì§„í–‰í•˜ë©´ ì •í™•ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</li></ul><button className="btn btn-primary" onClick={() => setShowPrivacy(false)}>í™•ì¸</button></div></div>)}
      {toast && <div className="toast" role="status" aria-live="polite">{toast}</div>}
    </div>
  );
};

export default VoiceAgeApp;

======================================

/* app.css

/* í°íŠ¸ & ë¦¬ì…‹ */
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

/* ë””ìì¸ í† í° */
:root{ --bg-grad-start:#667eea; --bg-grad-end:#764ba2; --glass-bg: rgba(255,255,255,.12); --glass-strong: rgba(255,255,255,.15); --glass-border: rgba(255,255,255,.18); --text-strong:#fff; --text-dim:rgba(255,255,255,.9); --text-soft:rgba(255,255,255,.75); --accent:#8b5cf6; --accent2:#ec4899; --ok:#22c55e; --danger:#ef4444; --info:#3b82f6; --shadow-md: 0 8px 20px rgba(0,0,0,.12); --shadow-lg: 0 12px 28px rgba(0,0,0,.18); --radius-lg: 20px; --radius-xl: 32px; --focus: 0 0 0 3px rgba(99,102,241,.45); }

/* ë ˆì´ì•„ì›ƒ */
.app-container { min-height: 100vh; background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 16px; color: var(--text-strong); box-sizing: border-box; }
.app-header, .main-content, .app-footer { width: 100%; max-width: 480px; margin: 0 auto; }

/* í—¤ë” */
.app-header { text-align: center; margin-bottom: 24px; }
.title-group { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
.sparkle-icon { animation: sparkle 2s infinite; }
@keyframes sparkle { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.8; } 50% { transform: scale(1.1) rotate(180deg); opacity: 1; } }
.title-group h1 { font-size: 2.4rem; font-weight: 800; margin: 0; background: linear-gradient(45deg, #fff, #f0f9ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.subtitle { font-size: 1.1rem; color: var(--text-dim); margin-bottom: 16px; font-weight: 500; }
.header-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.user-counter { display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-soft); font-size: 0.9rem; background: rgba(255, 255, 255, 0.1); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(10px); }
.privacy-btn{ display:inline-flex; align-items:center; gap:6px; color:#fff; background: rgba(255,255,255,.15); border:1px solid var(--glass-border); padding:8px 12px; border-radius: 12px; cursor:pointer; transition: .2s; }
.privacy-btn:hover{ background: rgba(255,255,255,.25); transform: translateY(-1px); }
.privacy-btn:focus-visible{ outline:none; box-shadow: var(--focus); }

/* ì¹´ë“œ */
.card { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border-radius: var(--radius-xl); padding: 32px; box-shadow: var(--shadow-lg); border: 1px solid var(--glass-border); }
.card-status-display { text-align: center; margin-bottom: 24px; min-height: 220px; display: flex; align-items: center; justify-content: center; }
.status-content { display: flex; flex-direction: column; align-items: center; gap: 18px; width: 100%; }

/* Idle */
.idle-icon { width: 120px; height: 120px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; border:0; }
.idle-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
.idle-icon:focus-visible{ outline:none; box-shadow: var(--focus); }
.mic-pulse { position: relative; z-index: 2; }
.idle-icon::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, rgba(255, 255, 255, 0.3), transparent); animation: rotate 3s linear infinite; }
@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.idle-text h2 { font-size: 1.6rem; font-weight: 800; margin: 0 0 8px 0; }
.idle-text p { font-size: 1rem; color: var(--text-dim); margin: 0 0 16px 0; }
.idle-features { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
.idle-features span { background: rgba(255, 255, 255, 0.15); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; font-weight: 600; }

/* Recording */
.recording-text .info { font-size: 1rem; color: var(--text-dim); }
.recording-wave { display: flex; gap: 4px; align-items: end; height: 40px; }
.wave-bar { width: 4px; background: rgba(255, 255, 255, 0.9); border-radius: 2px; }

/* Recorded */
.recorded-icon { width: 120px; height: 120px; background: var(--ok); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: successBounce 0.6s ease-out; }
@keyframes successBounce { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
.recorded-text h2 { font-size: 1.4rem; font-weight: 800; margin: 0 0 8px 0; }
.recorded-text p { font-size: 1rem; color: var(--text-dim); margin: 0 0 12px 0; }
.recorded-preview { display: inline-flex; align-items: center; gap: 8px; background: rgba(255, 255, 255, 0.15); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; }

/* Analyzing */
.analyzing-icon { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: spin 2s linear infinite; background: conic-gradient(from 0deg, #8b5cf6, #ec4899, #f97316, #8b5cf6); padding: 8px; }
.analyzing-icon-inner { width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.analyzing-text h2 { font-size: 1.4rem; font-weight: 800; margin: 0 0 8px 0; }
.analyzing-text p { font-size: 1rem; color: var(--text-dim); margin: 0 0 16px 0; }
.analyzing-steps { display: flex; flex-direction: column; gap: 8px; text-align: left; }
.step { padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; background: rgba(255, 255, 255, 0.1); opacity: 0.5; transition: all 0.3s ease; }
.step.active { background: rgba(34, 197, 94, 0.3); opacity: 1; }
.step.loading { background: rgba(249, 115, 22, 0.3); opacity: 1; animation: loading 1.5s infinite; }
@keyframes loading { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

/* Result */
.result-container { width: 100%; animation: fadeIn 0.5s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.result-header { text-align: center; margin-bottom: 18px; }
.result-title { font-size: 1.6rem; font-weight: 900; margin: 0 0 8px 0; }
.badge-unique{ margin-left:8px; padding:4px 8px; background:linear-gradient(135deg,#f59e0b,#f43f5e); color:#fff; border-radius:999px; font-size:.75rem; vertical-align: middle; }
.result-summary .humor-quote { font-size: 1.1rem; font-style: italic; color: var(--text-dim); margin: 0; line-height: 1.5; }
.insight-chips{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:14px 0 6px; }
.chip{ background: rgba(255,255,255,.16); border:1px solid var(--glass-border); padding:6px 10px; border-radius:999px; font-size:.85rem; font-weight:700; }
.scores-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.score-item { background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.score-icon { color: #f59e0b; }
.score-label { font-size: 0.9rem; color: var(--text-soft); }
.score-value { font-size: 1.3rem; font-weight: 800; }
.score-desc { font-size: 0.8rem; margin: 4px 0 0 0; color: var(--text-soft); text-align: center; }
.radar-chart-container { width: 100%; height: 250px; margin: 0; }
.radar-title { font-size: 1rem; font-weight: 700; color: var(--text-dim); text-align: center; margin: 18px 0 0 0; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 18px; }
.result-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px; }
.detail-card { background: var(--glass-strong); border-radius: 20px; padding: 20px; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); transition: transform 0.2s ease; }
.detail-card:hover { transform: translateY(-2px); }
.card-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
.animal-emoji, .personality-emoji, .job-emoji { font-size: 2rem; flex-shrink: 0; }
.card-header h4 { font-size: 0.9rem; font-weight: 800; margin: 0 0 4px 0; color: var(--text-soft); }
.card-header p { font-size: 0.98rem; font-weight: 800; margin: 0; line-height: 1.3; }
.card-desc { font-size: 0.85rem; color: var(--text-soft); font-style: italic; }
.special-tags { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 16px; }
.special-tag { background: linear-gradient(45deg, #8b5cf6, #ec4899); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 800; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }

/* ë²„íŠ¼ */
.button-group { display: flex; flex-direction: column; gap: 16px; margin-top: 18px; }
.grid-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.btn { width: 100%; padding: 16px 20px; border-radius: 20px; font-weight: 800; font-size: 1rem; transition: all 0.25s ease; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; backdrop-filter: blur(10px); }
.btn:focus-visible{ outline:none; box-shadow: var(--focus); }
.btn-primary { background: rgba(255, 255, 255, 0.92); color: #6d28d9; box-shadow: var(--shadow-md); }
.btn-primary:hover { background: white; transform: translateY(-2px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); }
.btn-danger { background: var(--danger); color: white; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }
.btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
.btn-secondary { background: var(--info); color: white; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); }
.btn-secondary:hover { background: #2563eb; transform: translateY(-2px); }
.btn-light { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.35); }
.btn-light:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
.btn-accent { background: linear-gradient(135deg, #9333ea, #db2777); color: white; box-shadow: 0 8px 20px rgba(147, 51, 234, 0.4); }
.btn-accent:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 12px 25px rgba(147, 51, 234, 0.5); }
.btn-details { margin-top: 20px; background: rgba(255, 255, 255, 0.92); color: #6d28d9; }
.btn-back { margin-top: 10px; background: rgba(255, 255, 255, 0.2); color: white; }

/* ê³ ì • CTA */
.cta-sticky{ position: fixed; left: 50%; bottom: 14px; transform: translateX(-50%); width: calc(100% - 24px); max-width: 480px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; z-index: 100; padding: 8px; border-radius: 16px; background: rgba(30,30,30,.35); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.2); }
.btn-share { background: linear-gradient(135deg, #06b6d4, #3b82f6); color: white; }
.btn-download { background: linear-gradient(135deg, #10b981, #059669); color: white; }

/* ìƒ˜í”Œ & ì—ëŸ¬ */
.sample-text-box { margin-bottom: 18px; padding: 18px; background: var(--glass-strong); border-radius: 20px; border: 1px solid var(--glass-border); }
.sample-text-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; font-weight: 800; }
.sample-text-header button { background: rgba(255, 255, 255, 0.2); border: none; border-radius: 8px; padding: 6px; color: white; cursor: pointer; transition: all 0.2s ease; }
.sample-text-header button:hover { background: rgba(255, 255, 255, 0.3); transform: rotate(180deg); }
.sample-text-box p { font-size: 0.95rem; line-height: 1.6; margin: 0; }
.error-box { margin-bottom: 12px; display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 16px; }
.error-box button { margin-left: auto; background: none; border: none; color: white; cursor: pointer; }

/* í‘¸í„° */
.app-footer { margin-top: 18px; text-align: center; color: var(--text-soft); font-size: 0.9rem; }

/* ëª¨ë‹¬ & ìº¡ì²˜ */
.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.65); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); padding:16px; }
.share-modal { background: rgba(255, 255, 255, 0.95); color: #1f2937; padding: 28px; border-radius: 24px; text-align: center; max-width: 360px; width:100%; }
.privacy-modal{ background:#18181b; color:#fff; padding: 22px; border-radius: 20px; width:100%; max-width: 420px; border:1px solid rgba(255,255,255,.15); }
.privacy-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.privacy-head h3{ margin:0; font-size:1.1rem; }
.privacy-head button{ background:transparent; color:#fff; border:0; cursor:pointer; }
.privacy-list{ margin:0 0 14px 0; padding-left:18px; }
.privacy-list li{ margin:8px 0; color:var(--text-dim); }
.capture-container { position: absolute; top: 0; left: -9999px; z-index: -1; width: 480px; padding: 32px; background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); color: white; box-sizing: content-box; }

/* í† ìŠ¤íŠ¸ */
.toast{ position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,.9); color:#fff; padding:10px 14px; border-radius:14px; box-shadow: var(--shadow-md); z-index: 1200; }

/* ì ‘ê·¼ì„±/ì„±ëŠ¥ */
@media (max-width: 480px) { .app-container { padding: 20px 12px; } .card { padding: 24px; backdrop-filter: blur(10px); } .title-group h1 { font-size: 2.1rem; } .result-details-grid { grid-template-columns: 1fr; } .scores-row { grid-template-columns: 1fr; } }
@media (prefers-reduced-motion: reduce){ .sparkle-icon, .analyzing-icon { animation: none; } }

/* ê³µìœ /ì €ì¥ìš© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.capture-container { position: absolute; top: 0; left: -9999px; z-index: -1; width: 720px; padding: 36px; background: linear-gradient(135deg, #5f68e6 0%, #6b53b4 45%, #8f4fa8 100%); color: white; box-sizing: content-box; }
.share-card{ position: relative; width: 100%; border-radius: 28px; overflow: hidden; box-shadow: 0 24px 60px rgba(0,0,0,.28); background: radial-gradient(1200px 800px at 10% -10%, rgba(255,255,255,.14), transparent 60%), radial-gradient(800px 600px at 100% 0%, rgba(255,255,255,.08), transparent 55%), rgba(255,255,255,.12); backdrop-filter: blur(18px); border: 1px solid rgba(255,255,255,.18); }
.share-card__frame{ position:absolute; inset:0; pointer-events:none; background: linear-gradient(135deg, rgba(255,255,255,.6), rgba(255,255,255,0) 30%) border-box; mask: linear-gradient(#000 0 0) padding-box, linear-gradient(#000 0 0); -webkit-mask: linear-gradient(#000 0 0) padding-box, linear-gradient(#000 0 0); }
.share-card__ribbon{ position: relative; display:flex; align-items:center; gap:10px; padding: 14px 18px; background: linear-gradient(90deg, rgba(255,255,255,.18), rgba(255,255,255,.08)); border-bottom: 1px solid rgba(255,255,255,.18); }
.ribbon__logo{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:50%; background: linear-gradient(135deg,#f59e0b,#f43f5e); color:#fff; }
.ribbon__brand{ font-weight:900; letter-spacing: .12em; font-size:.9rem; }
.ribbon__tagline{ margin-left:auto; font-size:.8rem; opacity:.85; }
.share-card__content{ padding: 22px 22px 18px; }
.share-card__title{ display:flex; align-items:center; gap:10px; margin-bottom: 14px; }
.share-card__title h2{ margin:0; font-weight:900; font-size:1.4rem; letter-spacing:-.01em; }
.badge{ background: linear-gradient(135deg,#8b5cf6,#ec4899); color:#fff; font-weight:800; font-size:.8rem; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.25); }
.share-card__headline{ display:flex; gap:16px; align-items:stretch; margin-bottom: 14px; }
.headline__age{ flex: 1.2; background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.10)); border:1px solid rgba(255,255,255,.22); border-radius: 16px; padding: 16px 18px; }
.age__label{ display:block; font-size:.85rem; opacity:.85; margin-bottom:4px; }
.age__value{ font-size:1.5rem; font-weight:900; letter-spacing:-.02em; }
.headline__metrics{ flex: 1; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
.metric{ display:flex; align-items:center; gap:8px; justify-content:center; background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.10)); border:1px solid rgba(255,255,255,.22); border-radius: 16px; padding: 12px; }
.metric__label{ font-size:.8rem; opacity:.85; }
.metric__value{ font-size:1.15rem; font-weight:900; }
.share-card__quote{ margin: 12px 0 16px; padding: 14px 16px; background: rgba(0,0,0,.18); border-left: 4px solid rgba(245,158,11,.9); border-radius: 12px; font-size: .98rem; line-height: 1.5; }
.share-card__grid{ display:grid; grid-template-columns: repeat(4,1fr); gap: 12px; }
.mini-card{ background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.20); border-radius: 14px; padding: 12px; }
.mini-card__head{ display:flex; align-items:center; gap:8px; margin-bottom:6px; opacity:.95; }
.mini-card__title{ font-size:.8rem; font-weight:800; }
.mini-card__value{ font-weight:900; font-size:.95rem; line-height:1.25; }
.mini-card__desc{ margin-top:6px; font-size:.78rem; opacity:.85; }
.emoji{ font-size:1.1rem; }
.share-card__hashtags{ margin-top: 16px; display:flex; flex-wrap:wrap; gap:8px; }
.tag{ background: rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.28); padding:6px 10px; border-radius:999px; font-size:.85rem; font-weight:800; }
.share-card__footer{ display:flex; align-items:center; justify-content:space-between; padding: 10px 16px; border-top: 1px solid rgba(255,255,255,.18); background: linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); }
.footer__brand{ display:inline-flex; align-items:center; gap:6px; font-weight:900; letter-spacing:.08em; }
.footer__url{ font-size:.85rem; opacity:.9; }
@media (max-width: 720px){ .share-card__grid{ grid-template-columns: 1fr 1fr; } }

/* Idle ìƒíƒœ - ì„±ë³„ ì„ íƒ */
.gender-selector { margin-bottom: 20px; width: 100%; }
.gender-title { font-size: 1rem; font-weight: 700; color: var(--text-dim); margin: 0 0 12px 0; }
.gender-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.btn-gender { padding: 14px; border-radius: 16px; font-weight: 800; font-size: 1rem; transition: all 0.25s ease; border: 2px solid var(--glass-border); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--glass-bg); color: var(--text-dim); }
.btn-gender:hover { background: var(--glass-strong); border-color: rgba(255,255,255,0.4); }
.btn-gender.selected { background: rgba(255, 255, 255, 0.92); color: #6d28d9; border-color: transparent; box-shadow: var(--shadow-md); }

/* ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn:disabled, .idle-icon:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
.idle-icon:disabled:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1); }
.idle-icon:disabled::before { animation: none; }

==================================================

# api/analyze.py

from fastapi import FastAPI, File, UploadFile, HTTPException, Form
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
import librosa
import numpy as np
import io
from pydub import AudioSegment
import random
import traceback
import hashlib

API_VERSION = "1.3.0"

app = FastAPI()

# CORS
origins = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
    "https://voice-age-app.vercel.app"  # ğŸš¨ ì—ëŸ¬ ë¡œê·¸ì— ë‚˜ì˜¨ ì£¼ì†Œë¥¼ ì •í™•í•˜ê²Œ ì¶”ê°€
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- ì œí•œ/ê°€ë“œ ìƒìˆ˜ ---
MIN_SEC = 0.5
MAX_SEC = 12
MAX_BYTES = 10 * 1024 * 1024  # 10MB

# --- ë°ì´í„° í’€ ---
voice_analysis_data = {
    "age_groups": {
        "10s": {"range": "10ëŒ€", "humor": ["ëª©ì†Œë¦¬ì—ì„œ 'ì—„ë§ˆ ìš©ëˆ ì˜¬ë ¤ë‹¬ë¼'ëŠ” ê°„ì ˆí•¨ì´ ëŠê»´ì ¸ìš”! ğŸŒ¸", "ë¼ë©´ ë“ì´ëŠ” ì†Œë¦¬ë§Œ ë“¤ì–´ë„ ë‹¬ë ¤ì˜¬ ê²ƒ ê°™ì€ ëª©ì†Œë¦¬! âš¡", "ë°¤ 12ì‹œì— 'ìˆ™ì œ ì–¸ì œ í•˜ì§€?' í•˜ëŠ” ëª©ì†Œë¦¬ë„¤ìš”! ğŸ“±", "ì²­ì¶˜ ë“œë¼ë§ˆì—ì„œ 'ì•¼, ë„ˆ ì¢‹ì•„í•´' ê³ ë°±í•  ëª©ì†Œë¦¬! ğŸ­", "ìƒˆë¡œ ë‚˜ì˜¨ ì¤„ì„ë§ì„ ì¼ì£¼ì¼ ë§Œì— ë§ˆìŠ¤í„°í•  ê²ƒ ê°™ì•„ìš”!", "ì—ë„ˆì§€ ë“œë§í¬ê°€ ëª©ì†Œë¦¬ë¡œ ë³€í•œ ëŠë‚Œ!"]},
        "20s_early": {"range": "20ëŒ€ ì´ˆë°˜", "humor": ["ëŒ€í•™ ê³¼ì œ ë§ˆê° 2ì‹œê°„ ì „ì˜ ì ˆë§ê³¼ í¬ë§ì´ ê³µì¡´í•˜ëŠ” ëª©ì†Œë¦¬! ğŸ“", "ë°¤ìƒˆ íŒ€í”Œí•˜ê³  'ì´ë²ˆì—” ì§„ì§œ A+ ë°›ì„ ê±°ì•¼' í•˜ëŠ” ëª©ì†Œë¦¬!", "MTì—ì„œ 'ìš°ë¦¬ ê³¼ ìµœê³ !' ì™¸ì¹  ëª©ì†Œë¦¬ì—ìš”!", "'ì˜¤ëŠ˜ ë­ ë¨¹ì§€?'ê°€ ì¸ìƒ ìµœëŒ€ ê³ ë¯¼ì¸ ëª©ì†Œë¦¬!", "ê°œê°•íŒŒí‹° ì£¼ìµœì ëª©ì†Œë¦¬ë„¤ìš”!", "ì¹œêµ¬ ë²ˆí˜¸ ë¬¼ì–´ë´ë‹¬ë¼ê³  ë¶€íƒë°›ì„ ëª©ì†Œë¦¬!"]},
        "20s_late": {"range": "20ëŒ€ í›„ë°˜", "humor": ["ì´ì œ ë§‰ 'ì–´ë¥¸'ì´ë¼ëŠ” ê°€ë©´ì„ ì“°ê¸° ì‹œì‘í•œ ëª©ì†Œë¦¬! ğŸº", "í‡´ê·¼ê¸¸ì— 'ì˜¤ëŠ˜ë„ ê³ ìƒí–ˆë‹¤' í˜¼ì£ë§í•  ëª©ì†Œë¦¬ë„¤ìš”!", "ì²« ì›”ê¸‰ìœ¼ë¡œ 'ì´ì œì•¼ ì‚¬ëŒ ëë‹¤' ëŠë¼ëŠ” ëª©ì†Œë¦¬!", "ì£¼ë§ ì•½ì† ì—†ìœ¼ë©´ ì¸ì‹¸ ìê²© ë°•íƒˆë‹¹í•  ê²ƒ ê°™ì€ ëª©ì†Œë¦¬!", "ì—°ì• í•  ë•Œ ê°€ì¥ ì„¤ë ˆì§€ë§Œ í˜„ì‹¤ì€ ì†”ë¡œì¸ ëª©ì†Œë¦¬ ğŸ’•", "ë…ë¦½ í›„ 'ì§‘ì—ì„œ ì†ì˜·ë§Œ ì…ê³  ë‹¤ë‹ˆëŠ” ììœ 'ë¥¼ ë§Œë½í•˜ëŠ” ëª©ì†Œë¦¬!"]},
        "30s_early": {"range": "30ëŒ€ ì´ˆë°˜", "humor": ["ì•ˆì •ê°ì€ ìˆëŠ”ë° ì—¬ì „íˆ ê²Œì„ ë°¤ìƒˆëŠ” ëª©ì†Œë¦¬ì˜ˆìš”.", "ë„·í”Œë¦­ìŠ¤ ì •ì£¼í–‰ì´ ìµœê³ ì˜ íë§ì´ë¼ê³  í™•ì‹ í•˜ëŠ” ëª©ì†Œë¦¬!", "'ì•„, í—ˆë¦¬ì•¼...' ì²« ì‹ ìŒì†Œë¦¬ë¥¼ ë‚¸ ëª©ì†Œë¦¬!", "íšŒì‚¬ì—ì„œ 'ë¯¿ê³  ë§¡ê¸¸ ìˆ˜ ìˆëŠ”' ëª©ì†Œë¦¬ ğŸ’¼", "ê²°í˜¼ì‹ ì¶•ì‚¬ì—ì„œ ì›ƒìŒê³¼ ê°ë™ì„ ë™ì‹œì— ì¤„ ëª©ì†Œë¦¬!", "ì»¤í”¼ ì—†ìœ¼ë©´ ì¢€ë¹„ê°€ ë˜ëŠ” ëª©ì†Œë¦¬ â˜•"]},
        "30s_late": {"range": "30ëŒ€ í›„ë°˜", "humor": ["ê¹Šì´ëŠ” ìˆëŠ”ë° ì•„ì§ ìœ íŠœë¸Œ ì•Œê³ ë¦¬ì¦˜ì— ë‹¹í•˜ëŠ” ëª©ì†Œë¦¬! ğŸ’°", "ì¬í…Œí¬ ìœ íŠœë¸Œ ë³´ë©´ì„œ 'ë‚˜ë„ ë¶€ì ë  ìˆ˜ ìˆì–´' í•˜ëŠ” ëª©ì†Œë¦¬!", "ìœ¡ì•„ í˜„ì‹¤ì— ì¹˜ì—¬ë„ ì•„ì´ ì•ì—ì„  ì²œì‚¬ê°€ ë˜ëŠ” ëª©ì†Œë¦¬ ğŸ‘¶", "ìº í•‘ ê°€ì„œ 'ìì—°ì´ ìµœê³ ì•¼' í•˜ì§€ë§Œ ì™€ì´íŒŒì´ ì°¾ëŠ” ëª©ì†Œë¦¬!", "ì¸ìƒ í™©ê¸ˆê¸°ë¼ì§€ë§Œ ì²´ë ¥ì€ ì´ë¯¸ í•˜í–¥ê³¡ì„ ì¸ ëª©ì†Œë¦¬! âœ¨", "'ì§‘ì´ ì²œêµ­'ì´ë¼ëŠ” ì§„ë¦¬ë¥¼ ê¹¨ë‹¬ì€ ëª©ì†Œë¦¬!"]},
        "40s_early": {"range": "40ëŒ€ ì´ˆë°˜", "humor": ["í¸ì•ˆí•˜ì§€ë§Œ ê°‘ìê¸° 'ìš”ì¦˜ ì• ë“¤ì€...' í•˜ê³  ì‹¶ì–´ì§€ëŠ” ëª©ì†Œë¦¬!", "ì™€ì¸ ë§ˆì‹œë©´ì„œ 'ì¸ìƒì„ ë…¼í•˜ê³ ' ì‹¶ì–´ì§€ëŠ” ëª©ì†Œë¦¬ ğŸ·", "í›„ë°°ë“¤ì—ê²Œ ë°¥ ì‚¬ì£¼ë©´ì„œ 'ë‚´ ì Šì—ˆì„ ë•ŒëŠ”' ì‹œì „í•  ëª©ì†Œë¦¬!", "ì•„ì´ ìˆ™ì œ ë„ì™€ì£¼ë‹¤ê°€ 'ì´ê²Œ ë­ì•¼?' í•  ëª©ì†Œë¦¬ ğŸ“", "ê²½í—˜ë‹´ì´ ë ˆì „ë“œê°€ ëœ ëª©ì†Œë¦¬ ğŸ“š", "ê³¨í”„ ì¹˜ë©´ì„œ 'ìŠ¤íŠ¸ë ˆìŠ¤ í‘¸ëŠ”' ëª©ì†Œë¦¬!"]},
        "40s_late": {"range": "40ëŒ€ í›„ë°˜", "humor": ["ì§€í˜œë¡­ì§€ë§Œ ì•„ì§ ìŠ¤ë§ˆíŠ¸í° ê¸°ëŠ¥ì„ ë‹¤ ëª¨ë¥´ëŠ” ëª©ì†Œë¦¬!", "'ë‚´ê°€ ë„ˆ ë•ŒëŠ”...' ì „ì„¤ì˜ ì‹œì‘ì„ ì•Œë¦¬ëŠ” ëª©ì†Œë¦¬!", "ì¸ìƒì˜ ë‹¨ë§›ì„ ì•„ëŠ” ë™ì‹œì— ì“´ë§›ë„ ì•„ëŠ” ëª©ì†Œë¦¬!", "ë‹¤í ë³´ë©´ì„œ 'ì—­ì‹œ ì˜›ë‚ ì´ ì¢‹ì•˜ì–´' í•  ëª©ì†Œë¦¬!", "ê°€ì¡±ì—¬í–‰ ê³„íš ì„¸ìš°ëŠ” ê²Œ ì·¨ë¯¸ê°€ ëœ ëª©ì†Œë¦¬!", "ì¹œêµ¬ ëª¨ì„ì—ì„œ 'ê±´ê°•ì´ ìµœê³ ì•¼' ì™¸ì¹˜ëŠ” ëª©ì†Œë¦¬!"]},
        "50s_plus": {"range": "50ëŒ€ ì´ìƒ", "humor": ["ëª¨ë“  ê²ƒì„ ë‹¤ ê²ªì–´ë³¸ 'ì¸ìƒ ê³ ìˆ˜'ì˜ ì—¬ìœ ë¡œìš´ ëª©ì†Œë¦¬!", "ì°¨ í•œ ì”ì— 'ì¸ìƒ ì² í•™'ì„ ë‹´ì•„ë‚¼ ìˆ˜ ìˆëŠ” ëª©ì†Œë¦¬ ğŸµ", "'ì´ì œì•¼ ì§„ì§œ ë‚´ ì¸ìƒì´ ì‹œì‘ì´ì•¼' í•˜ëŠ” ëª©ì†Œë¦¬ ğŸ­", "ì†ì ì†ë…€ì—ê²Œ 'ì˜›ë‚ ì— í• ì•„ë²„ì§€ëŠ”...' ì‹œì „í•˜ëŠ” ëª©ì†Œë¦¬!", "ë“±ì‚°ë³µì´ ì¼ìƒë³µì´ ëœ ëª©ì†Œë¦¬ ğŸ”ï¸", "í…ƒë°­ì—ì„œ 'ë‚´ê°€ ê¸°ë¥¸ ë°°ì¶”ê°€ ìµœê³ ì•¼' í•˜ëŠ” ëª©ì†Œë¦¬!"]},
    },
    "animalTypes": [
        {"id": "cat", "type": "ê³ ì–‘ì´ìƒ", "emoji": "ğŸ±", "desc": "ì¸¤ë°ë ˆì˜ ì™„ì„±ì²´, ê´€ì‹¬ì—†ëŠ” ì²™ í•˜ì§€ë§Œ ì‚¬ì‹¤ ê´€ì¢…"},
        {"id": "dog", "type": "ê°•ì•„ì§€ìƒ", "emoji": "ğŸ¶", "desc": "ì„¸ìƒ ëª¨ë“  ì‚¬ëŒì´ ì¢‹ì€ ì‚¬ëŒì¼ ê±°ë¼ê³  ë¯¿ëŠ” ìˆœìˆ˜í•¨"},
        {"id": "bear", "type": "ê³°ìƒ", "emoji": "ğŸ»", "desc": "í¬ê·¼í•œ ì¸ê°„ ë‹´ìš”, ì•ˆê¸°ê³  ì‹¶ê²Œ ë§Œë“œëŠ” ë§ˆì„±ì˜ ì²´ì§ˆ"},
        {"id": "fox", "type": "ì—¬ìš°ìƒ", "emoji": "ğŸ¦Š", "desc": "ê³„ì‚°ê¸°ë³´ë‹¤ ë¹ ë¥¸ ë‘ë‡Œ, ëˆˆë¹›ë§Œìœ¼ë¡œ ì‚¬ëŒ í™€ë¦¬ëŠ” ë§ˆë²•ì‚¬"},
        {"id": "hamster", "type": "í–„ìŠ¤í„°ìƒ", "emoji": "ğŸ¹", "desc": "ì…ì— ìŒì‹ ê°€ë“ ë„£ê³ ë„ ê·€ì—¬ìš´ ë°˜ì¹™ê¸‰ ì™¸ëª¨"},
        {"id": "lion", "type": "ì‚¬ììƒ", "emoji": "ğŸ¦", "desc": "ê°€ë§Œíˆ ìˆì–´ë„ í¬ìŠ¤ í­ë°œ, ì²œìƒì²œí•˜ ìœ ì•„ë…ì¡´"},
        {"id": "rabbit", "type": "í† ë¼ìƒ", "emoji": "ğŸ°", "desc": "ê¹œì°í•¨ìœ¼ë¡œ ì„¸ìƒì„ ì •ë³µí•˜ëŠ” ì¤‘, ë³´í˜¸ë³¸ëŠ¥ ìê·¹ ì „ë¬¸ê°€"},
        {"id": "wolf", "type": "ëŠ‘ëŒ€ìƒ", "emoji": "ğŸº", "desc": "ì•¼ì„±ë¯¸ ì² ì²  í˜ëŸ¬ë„˜ì¹˜ëŠ” ë§¤ë ¥, ê¸¸ë“¤ì—¬ì§€ì§€ ì•ŠëŠ” ììœ ë¡œìš´ ì˜í˜¼"}
    ],
    "personalityTypes": [
        {"id": "leader", "type": "íƒ€ê³ ë‚œ ë¦¬ë”í˜•", "emoji": "ğŸ‘‘", "color": "#f59e0b"},
        {"id": "emotional", "type": "ë”°ëœ»í•œ ê°ì„±í˜•", "emoji": "ğŸ’", "color": "#ec4899"},
        {"id": "maker", "type": "ë¶„ìœ„ê¸° ë©”ì´ì»¤í˜•", "emoji": "ğŸ‰", "color": "#8b5cf6"},
        {"id": "stable", "type": "ê¹Šê³  ì°¨ë¶„í•œ ì•ˆì •í˜•", "emoji": "ğŸ§˜", "color": "#06b6d4"},
        {"id": "humorous", "type": "ìœ ë¨¸ëŸ¬ìŠ¤í•œ ì¬ë¯¸í˜•", "emoji": "ğŸ˜„", "color": "#10b981"},
        {"id": "artist", "type": "ì°½ì˜ì ì¸ ì•„í‹°ìŠ¤íŠ¸í˜•", "emoji": "ğŸ¨", "color": "#f97316"},
        {"id": "analytical", "type": "ì§€ì ì´ê³  ë¶„ì„ì ì¸ í˜•", "emoji": "ğŸ¤“", "color": "#6366f1"},
        {"id": "active", "type": "í™œë™ì ì¸ ìŠ¤í¬ì¸ í˜•", "emoji": "ğŸƒ", "color": "#ef4444"},
    ],
    "compatibilityJobs": ["ë¼ë””ì˜¤ DJ", "ì„±ìš°", "ê°€ìˆ˜", "ì•„ë‚˜ìš´ì„œ", "íŒŸìºìŠ¤í„°", "ìœ íŠœë²„", "êµì‚¬", "ìƒë‹´ì‚¬", "ë°°ìš°", "MC", "ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°", "í†µì—­ì‚¬", "ì½œì„¼í„° ìƒë‹´ì›", "ê°•ì‚¬"],
    "specialTags": ["ASMR ì²œì¬", "ëª©ì†Œë¦¬ ë§ˆì•½", "ê·€í˜¸ê°• ì£¼ì¸ê³µ", "ë³´ì´ìŠ¤ í”¼ì…”", "ìŒì„± ì¹˜ë£Œì‚¬", "íë§ ë³´ì´ìŠ¤", "ë§¤ë ¥ ë°œì‚°ê¸°", "ì¹´ë¦¬ìŠ¤ë§ˆ í­ë°œ", "ëª©ì†Œë¦¬ ê¿€", "ë³´ì»¬ DNA", "ìŒì„± ë§ˆìˆ ì‚¬", "ê·€ê° ì œì¡°ê¸°"],
    "voiceColors": ["ë£¨ë¹„ ë ˆë“œ", "ì‚¬íŒŒì´ì–´ ë¸”ë£¨", "ì—ë©”ë„ë“œ ê·¸ë¦°", "ê³¨ë“  ì˜ë¡œìš°", "ì•„ë©”ì‹œìŠ¤íŠ¸ í¼í”Œ", "ë‹¤ì´ì•„ëª¬ë“œ í™”ì´íŠ¸", "ì˜¤ë‹‰ìŠ¤ ë¸”ë™", "ë¡œì¦ˆ ê³¨ë“œ", "ì‹¤ë²„ í™”ì´íŠ¸", "ì½”ë°œíŠ¸ ë¸”ë£¨"]
}

# --- ìœ í‹¸ & ì „ì²˜ë¦¬ ---

def trim_and_normalize(y, sr):
    y = librosa.util.normalize(y)
    y, _ = librosa.effects.trim(y, top_db=30)
    return y

def median_filter_1d(x, k=5):
    if len(x) < k:
        return x
    pad = k // 2
    xp = np.pad(x, (pad, pad), mode='edge')
    return np.array([np.median(xp[i:i + k]) for i in range(len(x))])

# --- í”¼ì¹˜ í†µí•© ì¶”ì¶œ (median Hz, std Hz, std cents) ---

def extract_pitch_stats(y, sr):
    f0, _, _ = librosa.pyin(
        y,
        fmin=librosa.note_to_hz('C2'),
        fmax=librosa.note_to_hz('C7'),
        frame_length=1024,
        hop_length=256,
        center=True
    )
    v = f0[~np.isnan(f0)]
    if len(v) == 0:
        return 150.0, 15.0, 80.0  # ì•ˆì „ ê¸°ë³¸ê°’
    v = median_filter_1d(v, k=5)
    med = float(np.median(v))
    if len(v) == 1:
        return med, 15.0, 80.0
    std_hz = float(np.std(v))
    std_cents = float(1200.0 * np.std(np.log2(v / med)))  # í”¼ì¹˜ ë¶ˆë³€ì„±
    return med, std_hz, std_cents

# --- ì—ë„ˆì§€ (ë ˆë²¨ ë¬´ê°í™”) ---

def analyze_energy(y):
    rms = librosa.feature.rms(y=y)[0]
    if np.all(rms == 0):
        return 0.0
    db = librosa.amplitude_to_db(rms, ref=np.max)  # 0..-inf
    # í‰ê·  dBë¥¼ 0..1ë¡œ ë§¤í•‘(ì•½ -60~0dB ê°€ì •)
    norm = np.clip((db.mean() + 60.0) / 60.0, 0.0, 1.0)
    return float(norm)

# --- ë§í•˜ê¸° ì†ë„ í”„ë¡ì‹œ (ZCR + Spectral Flux í•˜ì´ë¸Œë¦¬ë“œ) ---

def analyze_speaking_rate(y, sr):
    intervals = librosa.effects.split(y, top_db=30)
    yv = np.concatenate([y[s:e] for s, e in intervals]) if len(intervals) else y
    z = float(np.mean(librosa.feature.zero_crossing_rate(y=yv, frame_length=1024, hop_length=256)))
    S = np.abs(librosa.stft(yv, n_fft=1024, hop_length=256))
    flux = float(np.mean(np.maximum(0, np.diff(S, axis=1)).mean(axis=0)))
    proxy = 0.85 * z + 0.15 * (flux / np.maximum(S.mean(), 1e-6))  # ê°€ë²¼ìš´ ë³´ì •
    # ê²½í—˜ì  ë²”ìœ„: 0.03..0.18 â†’ 70..180
    return float(70 + (np.clip(proxy, 0.03, 0.18) - 0.03) / (0.18 - 0.03) * (180 - 70))

# --- ì¡°í™”ë„(HNR) ì•ˆì „í™” ---

def analyze_harmonicity(y):
    y_h, y_p = librosa.effects.hpss(y)
    he = float(np.sum(y_h**2) + 1e-12)
    pe = float(np.sum(y_p**2) + 1e-12)
    hnr = 10.0 * np.log10(he / pe)
    return float(np.clip(hnr, -20.0, 20.0))

# --- ìŠ¤í™íŠ¸ëŸ¼ ì„¼íŠ¸ë¡œì´ë“œ ---

def analyze_spectral_centroid(y, sr):
    return float(np.mean(librosa.feature.spectral_centroid(y=y, sr=sr)))

# --- ë‚˜ì´ëŒ€ ì¶”ì • ê·œì¹™ ---

def get_age_key_female(pitch, spectral_centroid, energy_norm01):
    """ì—¬ì„± ëª©ì†Œë¦¬ ë‚˜ì´ëŒ€ ì¶”ì • (ì—ë„ˆì§€: 0~1 ì •ê·œí™” ê¸°ì¤€)"""
    if pitch > 245: return "10s"
    elif pitch > 220: return "20s_early"
    elif pitch > 200: return "20s_late"
    elif pitch > 185: return "30s_early" if energy_norm01 > 0.5 else "30s_late"
    elif pitch > 170: return "40s_early" if spectral_centroid > 2200 else "40s_late"
    else: return "50s_plus"

def get_age_key_male(pitch, spectral_centroid, energy_norm01):
    """ë‚¨ì„± ëª©ì†Œë¦¬ ë‚˜ì´ëŒ€ ì¶”ì • (ì—ë„ˆì§€: 0~1 ì •ê·œí™” ê¸°ì¤€)"""
    if pitch > 165: return "10s"
    elif pitch > 140: return "20s_early"
    elif pitch > 125: return "20s_late"
    elif pitch > 110: return "30s_early" if energy_norm01 > 0.5 else "30s_late"
    elif pitch > 95: return "40s_early" if spectral_centroid > 1800 else "40s_late"
    else: return "50s_plus"

# --- í”„ë¡œí•„ ì‚°ì¶œ (ì¹˜ìš°ì¹¨ ì™„í™” ì„ê³„ê°’ ìƒí–¥) ---

def get_voice_profile(features):
    profile = set()
    # pitch band
    if features['pitch'] > 180: profile.add('high_pitch')
    elif features['pitch'] < 130: profile.add('low_pitch')
    else: profile.add('mid_pitch')
    # energy (0~1)  â† high>0.75, low<0.30
    if features['energy'] > 0.75: profile.add('high_energy')
    elif features['energy'] < 0.30: profile.add('low_energy')
    else: profile.add('mid_energy')
    # clarity
    if features['harmonicity'] > 7.0: profile.add('clear_voice')
    elif features['harmonicity'] < 3.0: profile.add('husky_voice')
    else: profile.add('soft_voice')
    # stability: pitch std in cents â† dynamic>110c
    pitch_var = features.get('pitch_std_cents', None)
    if pitch_var is not None:
        profile.add('dynamic_tone' if pitch_var > 110.0 else 'stable_tone')
    else:
        profile.add('dynamic_tone' if features['pitch_std'] > 35 else 'stable_tone')
    return profile

# --- ì§ì—… ê°€ì¤‘ì¹˜ ìŠ¤ì½”ì–´ëŸ¬ (ì ë¦¼ ë°©ì§€) ---

def select_job_with_scores(profile, features, audio_bytes=None):
    jobs = [
        "ì•„ë‚˜ìš´ì„œ","MC","ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°","ë°°ìš°","ìœ íŠœë²„","ìƒë‹´ì‚¬",
        "ì„±ìš°","ê°€ìˆ˜","êµì‚¬","íŒŸìºìŠ¤í„°","ê°•ì‚¬","í†µì—­ì‚¬","ë¼ë””ì˜¤ DJ"
    ]
    scores = {j: 0.0 for j in jobs}

    tempo = float(features.get("tempo", 110.0))
    fast = tempo >= 120
    slow = tempo <= 95
    mid_speed = 95 < tempo < 130

    def add(job, w): scores[job] += w

    # ì•„ë‚˜ìš´ì„œ
    if 'clear_voice' in profile: add("ì•„ë‚˜ìš´ì„œ", 2.5)
    if 'stable_tone' in profile: add("ì•„ë‚˜ìš´ì„œ", 2.0)
    if 'mid_energy' in profile:  add("ì•„ë‚˜ìš´ì„œ", 1.0)
    if mid_speed:                add("ì•„ë‚˜ìš´ì„œ", 1.0)

    # MC (ì—„ê²©: ë¹ ë¥¸ ì†ë„ + ì—ë„ˆì§€ + ë‹¤ì´ë‚´ë¯¹)
    if 'high_energy' in profile and 'dynamic_tone' in profile: add("MC", 2.0)
    if fast:                                              add("MC", 2.0)
    if 'clear_voice' in profile:                          add("MC", 1.0)

    # ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°
    if 'low_energy' in profile: add("ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°", 2.0)
    if 'soft_voice' in profile: add("ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°", 2.0)
    if 'stable_tone' in profile: add("ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°", 1.0)
    if slow:                     add("ì˜¤ë””ì˜¤ë¶ ë‚´ë ˆì´í„°", 1.5)

    # ë°°ìš°
    if 'dynamic_tone' in profile: add("ë°°ìš°", 2.0)
    if 'husky_voice' in profile:  add("ë°°ìš°", 1.0)
    if 'high_energy' in profile:  add("ë°°ìš°", 0.5)

    # ìœ íŠœë²„
    if 'high_energy' in profile: add("ìœ íŠœë²„", 1.5)
    if 'clear_voice' in profile: add("ìœ íŠœë²„", 1.0)
    if 'dynamic_tone' in profile: add("ìœ íŠœë²„", 1.0)

    # ìƒë‹´ì‚¬
    if 'soft_voice' in profile:  add("ìƒë‹´ì‚¬", 2.0)
    if 'stable_tone' in profile: add("ìƒë‹´ì‚¬", 1.0)
    if 'low_energy' in profile:  add("ìƒë‹´ì‚¬", 1.0)

    # ì„±ìš°
    if 'clear_voice' in profile: add("ì„±ìš°", 2.0)
    if 'dynamic_tone' in profile: add("ì„±ìš°", 1.0)
    if 'mid_energy' in profile:  add("ì„±ìš°", 1.0)

    # ê°€ìˆ˜
    if 'clear_voice' in profile: add("ê°€ìˆ˜", 1.0)
    if 'high_pitch' in profile:  add("ê°€ìˆ˜", 1.0)
    if 'dynamic_tone' in profile: add("ê°€ìˆ˜", 0.5)

    # êµì‚¬
    if 'stable_tone' in profile: add("êµì‚¬", 2.0)
    if 'mid_energy' in profile:  add("êµì‚¬", 1.0)

    # íŒŸìºìŠ¤í„°
    if 'dynamic_tone' in profile: add("íŒŸìºìŠ¤í„°", 1.0)
    if 'soft_voice' in profile:   add("íŒŸìºìŠ¤í„°", 1.0)
    if 'mid_energy' in profile:   add("íŒŸìºìŠ¤í„°", 0.5)

    # ê°•ì‚¬
    if 'high_energy' in profile: add("ê°•ì‚¬", 2.0)
    if fast:                     add("ê°•ì‚¬", 1.0)
    if 'clear_voice' in profile: add("ê°•ì‚¬", 0.5)

    # í†µì—­ì‚¬
    if 'clear_voice' in profile: add("í†µì—­ì‚¬", 1.0)
    if 'stable_tone' in profile: add("í†µì—­ì‚¬", 1.0)
    if mid_speed:                add("í†µì—­ì‚¬", 1.0)
    if 'low_energy' in profile:  add("í†µì—­ì‚¬", 0.5)

    # ë¼ë””ì˜¤ DJ
    if 'soft_voice' in profile:  add("ë¼ë””ì˜¤ DJ", 1.0)
    if 'low_energy' in profile:  add("ë¼ë””ì˜¤ DJ", 0.5)
    if 'stable_tone' in profile: add("ë¼ë””ì˜¤ DJ", 0.5)

    ranked = sorted(scores.items(), key=lambda kv: kv[1], reverse=True)
    top3 = ranked[:3]
    if audio_bytes is not None and len(top3) > 1 and top3[0][1] == top3[1][1]:
        h = int(hashlib.md5(audio_bytes).hexdigest(), 16)
        top3 = sorted(top3, key=lambda kv: (kv[1], (h ^ hash(kv[0])) & 0xffff), reverse=True)

    best_job = top3[0][0]
    candidates = [{"job": j, "score": round(s, 2)} for j, s in top3]
    return best_job, candidates

# --- ì„¸ë¶€ ê²°ê³¼ ë§¤í•‘ (ì§ì—…=ê°€ì¤‘ì¹˜ ìŠ¤ì½”ì–´ëŸ¬ ì‚¬ìš©) ---

def analyze_details_based_on_profile(profile, features=None, audio_bytes=None):
    """ìŒì„± í”„ë¡œí•„ì„ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  ì„¸ë¶€ ê²°ê³¼ë¥¼ ê²°ì •"""
    voice_type_map = {
        ('high_energy', 'dynamic_tone'): "í™œê¸°ì°¬ ì—ë„ˆì§€ ë³´ì´ìŠ¤",
        ('high_pitch', 'clear_voice'): "ë§‘ê³  ì²­ëŸ‰í•œ í¬ë¦¬ìŠ¤íƒˆ ë³´ì´ìŠ¤",
        ('low_pitch', 'stable_tone'): "ê¹Šê³  ì¹´ë¦¬ìŠ¤ë§ˆ ìˆëŠ” ë² ì´ìŠ¤ ë³´ì´ìŠ¤",
        ('low_energy', 'soft_voice'): "ì°¨ë¶„í•˜ê³  ì†ì‚­ì´ëŠ” ìœ„ìŠ¤í¼ ë³´ì´ìŠ¤",
        ('clear_voice',): "ë”°ëœ»í•˜ê³  ë¶€ë“œëŸ¬ìš´ í—ˆë‹ˆ ë³´ì´ìŠ¤",
        ('husky_voice', 'high_energy'): "íŒŒì›Œí’€í•˜ê³  ê°•ë ¬í•œ ì¬ë” ë³´ì´ìŠ¤",
        ('mid_energy', 'dynamic_tone'): "ê°ì„±ì ì´ê³  ëª½í™˜ì ì¸ ë¬¸ë¼ì´íŠ¸ ë³´ì´ìŠ¤",
    }
    voice_type = "ì‹œì›í•˜ê³  ê¹”ë”í•œ ë¯¼íŠ¸ ë³´ì´ìŠ¤"
    for p_set, v_type in voice_type_map.items():
        if all(p in profile for p in p_set):
            voice_type = v_type
            break

    animal_type_map = {
        ('high_pitch', 'dynamic_tone'): "í† ë¼ìƒ",
        ('high_pitch', 'low_energy'): "ê³ ì–‘ì´ìƒ",
        ('high_pitch', 'high_energy'): "ê°•ì•„ì§€ìƒ",
        ('low_pitch', 'husky_voice'): "ëŠ‘ëŒ€ìƒ",
        ('low_pitch', 'high_energy'): "ì‚¬ììƒ",
        ('mid_pitch', 'stable_tone'): "ê³°ìƒ",
        ('mid_pitch', 'dynamic_tone'): "ì—¬ìš°ìƒ"
    }
    animal = "í–„ìŠ¤í„°ìƒ"
    for p_set, a_type in animal_type_map.items():
        if all(p in profile for p in p_set):
            animal = a_type
            break
    animal_type = next(
        (item for item in voice_analysis_data["animalTypes"] if item["type"] == animal),
        random.choice(voice_analysis_data["animalTypes"])
    )

    personality_type_map = {
        ('high_energy', 'dynamic_tone'): "ë¶„ìœ„ê¸° ë©”ì´ì»¤í˜•",
        ('low_energy', 'stable_tone'): "ê¹Šê³  ì°¨ë¶„í•œ ì•ˆì •í˜•",
        ('low_pitch', 'stable_tone'): "íƒ€ê³ ë‚œ ë¦¬ë”í˜•",
        ('high_pitch', 'dynamic_tone'): "ì°½ì˜ì ì¸ ì•„í‹°ìŠ¤íŠ¸í˜•",
        ('high_energy', 'clear_voice'): "í™œë™ì ì¸ ìŠ¤í¬ì¸ í˜•",
        ('husky_voice', 'dynamic_tone'): "ìœ ë¨¸ëŸ¬ìŠ¤í•œ ì¬ë¯¸í˜•",
        ('clear_voice', 'stable_tone'): "ì§€ì ì´ê³  ë¶„ì„ì ì¸ í˜•",
    }
    personality = "ë”°ëœ»í•œ ê°ì„±í˜•"
    for p_set, p_type in personality_type_map.items():
        if all(p in profile for p in p_set):
            personality = p_type
            break
    personality_type = next(
        (item for item in voice_analysis_data["personalityTypes"] if item["type"] == personality),
        random.choice(voice_analysis_data["personalityTypes"])
    )

    # â–¶ ê°€ì¤‘ì¹˜ ìŠ¤ì½”ì–´ ê¸°ë°˜ ì§ì—… ì„ ì •
    if features is not None:
        job, job_candidates = select_job_with_scores(profile, features, audio_bytes)
    else:
        job = "ë¼ë””ì˜¤ DJ"
        job_candidates = [{"job": "ë¼ë””ì˜¤ DJ", "score": 0.0}]

    tag_map = {
        ('low_energy', 'soft_voice'): "ASMR ì²œì¬",
        ('clear_voice', 'high_pitch'): "ê·€í˜¸ê°• ì£¼ì¸ê³µ",
        ('low_pitch', 'stable_tone'): "ì¹´ë¦¬ìŠ¤ë§ˆ í­ë°œ",
        ('soft_voice', 'clear_voice'): "ëª©ì†Œë¦¬ ê¿€",
        ('high_energy', 'dynamic_tone'): "ë§¤ë ¥ ë°œì‚°ê¸°",
        ('husky_voice', 'low_pitch'): "ë³´ì´ìŠ¤ í”¼ì…”",
    }
    tag = "íë§ ë³´ì´ìŠ¤"
    for p_set, t_type in tag_map.items():
        if all(p in profile for p in p_set):
            tag = t_type
            break

    color_map = {
        ('high_pitch', 'clear_voice'): "ì‚¬íŒŒì´ì–´ ë¸”ë£¨",
        ('high_pitch', 'high_energy'): "ê³¨ë“  ì˜ë¡œìš°",
        ('low_pitch', 'stable_tone'): "ì˜¤ë‹‰ìŠ¤ ë¸”ë™",
        ('low_pitch', 'husky_voice'): "ë£¨ë¹„ ë ˆë“œ",
        ('soft_voice', 'mid_pitch'): "ë¡œì¦ˆ ê³¨ë“œ",
        ('clear_voice', 'stable_tone'): "ì—ë©”ë„ë“œ ê·¸ë¦°",
        ('dynamic_tone', 'mid_energy'): "ì•„ë©”ì‹œìŠ¤íŠ¸ í¼í”Œ",
    }
    color = "ì‹¤ë²„ í™”ì´íŠ¸"
    for p_set, c_type in color_map.items():
        if all(p in profile for p in p_set):
            color = c_type
            break

    return {
        "voice_type": voice_type,
        "animal_type": {k: v for k, v in animal_type.items() if k not in ['id']},
        "personality_type": {k: v for k, v in personality_type.items() if k not in ['id']},
        "compatibility_job": job,
        "job_candidates": job_candidates,   # ìƒìœ„ 3ê°œ í›„ë³´ ì œê³µ
        "special_tag": tag,
        "voice_color": color,
    }

# --- ë ˆì´ë” ì •ê·œí™” (NaN ì•ˆì „) ---

def normalize_features_for_radar(features):
    # pitch: 80~250Hz â†’ 0~100
    pitch_score = np.nan_to_num((features["pitch"] - 80) / (250 - 80) * 100, nan=50.0)
    # energy: 0~1 â†’ 0~100
    energy_score = np.nan_to_num(features["energy"] * 100, nan=50.0)
    # speaking rate(tempo ìë¦¬): 70~180 â†’ 0~100
    tempo_score = np.nan_to_num((features["tempo"] - 70) / (180 - 70) * 100, nan=50.0)
    # HNR â†’ ì™„ë§Œ ìŠ¤ì¼€ì¼ (2.5*dB + 50)
    clearness_score = np.nan_to_num(features['harmonicity'] * 2.5 + 50, nan=50.0)
    # ì•ˆì •ê°: ì„¼íŠ¸ í‘œì¤€í¸ì°¨ ì‚¬ìš© ì‹œ ë” íƒ€ë‹¹ (ì‘ì„ìˆ˜ë¡ ì•ˆì •)
    if "pitch_std_cents" in features:
        c = float(features["pitch_std_cents"])
        # 40â†’90, 120â†’50, 200â†’10 ë¡œ ë§¤í•‘(êµ¬ê°„ ì™¸ëŠ” ì–‘ëìœ¼ë¡œ í¬í™”)
        stability_score = np.interp(c, [40, 120, 200], [90, 50, 10])
    else:
        # Hz í‘œì¤€í¸ì°¨ì¼ ë•Œë„ ëŒ€ëµì  ë³´ì •(í”¼ì¹˜ê°€ ë†’ì„ìˆ˜ë¡ ìœ ë¦¬í•˜ë¯€ë¡œ ë³´ìˆ˜ì ìœ¼ë¡œ)
        h = float(features["pitch_std"])
        stability_score = np.interp(h, [5, 20, 40], [90, 50, 10])

    stability_score = float(np.clip(stability_score, 10, 100))

    return [
        {"feature": "ë†’ì´", "value": int(np.clip(pitch_score, 10, 100))},
        {"feature": "ì—ë„ˆì§€", "value": int(np.clip(energy_score, 10, 100))},
        {"feature": "ì†ë„", "value": int(np.clip(tempo_score, 10, 100))},
        {"feature": "ë§‘ìŒ", "value": int(np.clip(clearness_score, 10, 100))},
        {"feature": "ì•ˆì •ê°", "value": int(np.clip(stability_score, 10, 100))},
    ]

def calculate_attraction_score(radar_data):
    values = [item['value'] for item in radar_data]
    average_score = np.mean(values)
    std_dev = np.std(values)
    balance_bonus = max(0, 25 - std_dev)
    ideal_range_bonus = 10 if all(40 <= v <= 85 for v in values) else 0
    final_score = 60 + (average_score - 50) * 0.5 + balance_bonus + ideal_range_bonus
    return min(99, max(60, int(final_score)))

# --- í’ˆì§ˆ ì§„ë‹¨ ---

def estimate_snr(y):
    rms = librosa.feature.rms(y=y)[0]
    med = np.median(rms)
    noise = np.percentile(rms, 10)
    return float(20 * np.log10((med + 1e-8) / (noise + 1e-8)))

def clipping_ratio(y):
    return float(np.mean(np.abs(y) > 0.98))

def choose_deterministic(seq, audio_bytes):
    if not seq:
        return None
    h = int(hashlib.md5(audio_bytes).hexdigest(), 16)
    return seq[h % len(seq)]

# --- ì—”ë“œí¬ì¸íŠ¸ ---

@app.post("/api/analyze")
async def analyze_voice(gender: str = Form(...), audio: UploadFile = File(...)):
    try:
        # content-type ê°€ë“œ(ë¸Œë¼ìš°ì € ì—…ë¡œë“œëŠ” ì¢…ì¢… application/octet-stream)
        if audio.content_type and not (
            audio.content_type.startswith("audio/") or audio.content_type == "application/octet-stream"
        ):
            raise HTTPException(status_code=400, detail=f"ì§€ì›í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸  íƒ€ì…ì…ë‹ˆë‹¤: {audio.content_type}")

        audio_bytes = await audio.read()
        if not audio_bytes:
            raise HTTPException(status_code=400, detail="ì˜¤ë””ì˜¤ íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
        if len(audio_bytes) > MAX_BYTES:
            raise HTTPException(status_code=400, detail=f"íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤(â‰¤ {MAX_BYTES // (1024*1024)}MB).")

        # pydub ë¡œë“œ
        try:
            sound = AudioSegment.from_file(io.BytesIO(audio_bytes))
        except Exception:
            raise HTTPException(status_code=400, detail="ì˜¤ë””ì˜¤ í¬ë§·ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. WAV/MP3 ë“± í‘œì¤€ í¬ë§·ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.")

        # ëª¨ë…¸ ë³€í™˜
        if sound.channels > 1:
            sound = sound.set_channels(1)

        # float32 íŒŒí˜•
        samples = np.array(sound.get_array_of_samples()).astype(np.float32) / (2 ** (sound.sample_width * 8 - 1))

        # ë¦¬ìƒ˜í”Œ
        target_sr = 22050
        y = librosa.resample(y=samples, orig_sr=sound.frame_rate, target_sr=target_sr)
        sr = target_sr

        # ì „ì²˜ë¦¬
        y = trim_and_normalize(y, sr)
        if len(y) < int(MIN_SEC * sr):
            raise HTTPException(status_code=400, detail=f"ì˜¤ë””ì˜¤ ê¸¸ì´ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤(â‰¥{MIN_SEC:.1f}ì´ˆ í•„ìš”).")
        if len(y) > int(MAX_SEC * sr):
            y = y[:int(MAX_SEC * sr)]

        # íŠ¹ì„± ì¶”ì¶œ (pyin 1íšŒ)
        pitch_med, pitch_std_hz, pitch_std_cents = extract_pitch_stats(y, sr)
        energy = analyze_energy(y)                    # 0~1
        speaking_rate = analyze_speaking_rate(y, sr)  # 70~180
        hnr = analyze_harmonicity(y)                  # -20~20 (í´ë¦¬í•‘)
        spec_cent = analyze_spectral_centroid(y, sr)

        features = {
            "pitch": pitch_med,
            "energy": energy,
            "tempo": speaking_rate,              # ê¸°ì¡´ í‚¤ ìœ ì§€(UI í˜¸í™˜)
            "pitch_std": pitch_std_hz,
            "pitch_std_cents": pitch_std_cents,
            "harmonicity": hnr
        }

        voice_profile = get_voice_profile(features)
        detailed_results = analyze_details_based_on_profile(voice_profile, features, audio_bytes)

        # ë‚˜ì´ëŒ€ ì¶”ì •
        if gender == 'female':
            age_key = get_age_key_female(features["pitch"], spec_cent, features["energy"])
        else:  # male or other
            age_key = get_age_key_male(features["pitch"], spec_cent, features["energy"])

        age_info = voice_analysis_data["age_groups"].get(age_key, voice_analysis_data["age_groups"]["30s_early"])

        # ë ˆì´ë”/ìŠ¤ì½”ì–´
        radar_data = normalize_features_for_radar(features)
        attraction_score = calculate_attraction_score(radar_data)

        # ìœ ë‹ˆí¬ë‹ˆìŠ¤(ì•ˆì „ ê³„ì‚°)
        uniqueness_score = int(np.clip(
            65
            + 0.20 * np.nan_to_num(features.get("pitch_std_cents", 80.0))
            + 25.0 * abs(np.nan_to_num(features["energy"]) - 0.5)
            + 1.5 * abs(np.nan_to_num(features["harmonicity"]) - 5.0),
            60, 99
        ))

        # ì…ë ¥ í’ˆì§ˆ ê²½ê³ 
        snr = estimate_snr(y)
        clip = clipping_ratio(y)
        voiced_ratio = float(sum((e - s) for s, e in librosa.effects.split(y, top_db=30)) / len(y))
        warnings = []
        if snr < 10:
            warnings.append("ì£¼ë³€ ì†ŒìŒì´ ì»¤ì„œ ì •í™•ë„ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”.")
        if clip > 0.02:
            warnings.append("ì…ë ¥ì´ í´ë¦¬í•‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬ ì…ë ¥ ë ˆë²¨ì„ ë‚®ì¶°ì£¼ì„¸ìš”.")
        if voiced_ratio < 0.4:
            warnings.append("ë¬´ìŒ êµ¬ê°„ì´ ë§ìŠµë‹ˆë‹¤. 2ì´ˆ ì´ìƒ ë˜ë°•ë˜ë°• ë§í•´ì£¼ì„¸ìš”.")

        # ê²°ì •ì  ìœ ë¨¸ ì„ íƒ(ê°™ì€ íŒŒì¼ â†’ ê°™ì€ ë¬¸êµ¬)
        humor = choose_deterministic(age_info["humor"], audio_bytes)

        result = {
            "version": API_VERSION,
            "age_range": age_info["range"],
            "humor_quote": humor,
            "attraction_score": attraction_score,
            "uniqueness_score": uniqueness_score,
            "radar_data": radar_data,
            "warnings": warnings,
            **detailed_results
        }

        return JSONResponse(content=result)

    except HTTPException:
        raise
    except Exception as e:
        traceback.print_exc()
        raise HTTPException(status_code=500, detail=f"An error occurred during analysis: {str(e)}")

@app.get("/")
async def root():
    return {"message": "Voice Age API is running!", "version": API_VERSION}

@app.get("/healthz")
async def healthz():
    return {"status": "ok", "version": API_VERSION}
